generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model ApiPricing {
  id         BigInt  @id
  name       String
  host       String
  api        String
  price      Decimal @db.Decimal(10, 4)
  apiKey     String? // API 密钥
  actualHost String? // 实际主机地址
  actualApi  String? // 实际接口地址
  isEnabled  Boolean @default(true) // 是否启用

  // 与用户的多对多关系
  userPricings UserPricing[] @relation("ApiPricingUserPricings")

  @@map("api_pricing")
}

model Setting {
  
  id          BigInt   @id
  key         String   @unique
  value       String   @db.Text
  description String?

  @@map("settings")
}

model User {
  id        BigInt   @id @default(autoincrement())
  clerkId   String   @unique
  email     String?  @unique
  name      String?
  avatarUrl String?
  role      String   @default("User")
  isActive  Boolean  @default(true)
  balance   Decimal  @default(0) @db.Decimal(12, 2) // 用户余额（元）
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 与请求日志的一对多关系
  apiRequestLogs ApiRequestLog[] @relation("UserApiRequestLogs")
  // 与定价配置的多对多关系
  userPricings UserPricing[] @relation("UserUserPricings")
  // 与小程序配置的一对多关系
  miniProgramSettings MiniProgramSettings[] @relation("UserMiniProgramSettings")
  // 与补偿任务的一对多关系
  compensationTasks CompensationTask[] @relation("UserCompensationTasks")

  @@map("users")
}

model ApiRequestLog {
  id             BigInt   @id @default(autoincrement())
  userClerkId    String   // 用户 Clerk ID
  user           User?    @relation("UserApiRequestLogs", fields: [userClerkId], references: [clerkId])
  serviceProvider String  // 服务商名称（记录时从 ApiPricing.name 复制，避免删除定价后无法显示）
  requestApi     String   // 请求接口（如方法+路径）
  requestBody    String   @db.Text // 请求参数
  responseBody   String   @db.Text // 返回参数/响应内容
  cost           Decimal  @db.Decimal(12, 4) // 请求费用
  createdAt      DateTime @default(now())    // 请求时间

  @@index([userClerkId, createdAt]) // 按用户和时间查询
  @@index([createdAt])              // 按时间范围查询
  @@index([cost])                   // 按费用区间/排序查询
  @@index([serviceProvider])        // 按服务商查询
  @@map("api_request_logs")
}

model UserPricing {
  id           BigInt     @id
  userId       BigInt     // 用户 ID
  user         User       @relation("UserUserPricings", fields: [userId], references: [id])
  apiPricingId BigInt     // 定价配置 ID
  apiPricing   ApiPricing @relation("ApiPricingUserPricings", fields: [apiPricingId], references: [id])
  createdAt    DateTime   @default(now()) // 关联创建时间

  @@unique([userId, apiPricingId]) // 防止重复关联：同一用户不能重复关联同一服务商
  @@index([userId])                // 按用户查询
  @@index([apiPricingId])          // 按定价配置查询
  @@map("user_pricings")
}

model MiniProgramSettings {
  id            BigInt   @id
  userId        BigInt   // 用户 ID
  user          User     @relation("UserMiniProgramSettings", fields: [userId], references: [id])
  name          String   // 小程序名称
  appid         String   // 小程序 AppID
  isApproved    Boolean  @default(false) // 审核状态
  apiPricingIds Json?    @default("[]") // 关联的服务商 ID 列表（JSON 数组）
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])        // 按用户查询
  @@index([name])          // 按名称查询
  @@index([appid])         // 按 AppID 查询
  @@index([isApproved])    // 按审核状态查询
  @@map("mini_program_settings")
}

model CompensationTask {
  id            BigInt    @id @default(autoincrement())
  userId        BigInt    // 用户 ID
  user          User      @relation("UserCompensationTasks", fields: [userId], references: [id])
  userPricingId BigInt    // UserPricing ID
  cost          Decimal   @db.Decimal(12, 4) // 需要扣除的费用
  status        String    @default("pending") // pending, processing, completed, failed
  retryCount    Int       @default(0) // 重试次数
  maxRetries    Int       @default(3) // 最大重试次数
  errorMessage  String?   @db.Text // 错误信息
  // 日志信息（用于对账）
  userClerkId    String   // 用户 Clerk ID
  serviceProvider String  // 服务商名称
  requestApi     String   // 请求接口
  requestBody    String   @db.Text // 请求参数
  responseBody   String   @db.Text // 响应内容
  completedAt   DateTime? // 完成时间
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status, createdAt]) // 按状态和时间查询
  @@index([userId]) // 按用户查询
  @@map("compensation_tasks")
}


