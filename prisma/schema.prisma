generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model ApiPricing {
  id         BigInt  @id
  name       String
  host       String
  api        String
  price      Decimal @db.Decimal(10, 4)
  apiKey     String? // API 密钥
  actualHost String? // 实际主机地址
  actualApi  String? // 实际接口地址

  // 与用户的多对多关系
  userPricings UserPricing[] @relation("ApiPricingUserPricings")

  @@map("api_pricing")
}

model Setting {
  id          BigInt   @id
  key         String   @unique
  value       String   @db.Text
  description String?

  @@map("settings")
}

model User {
  id        BigInt   @id @default(autoincrement())
  clerkId   String   @unique
  email     String?  @unique
  name      String?
  avatarUrl String?
  role      String   @default("User")
  isActive  Boolean  @default(true)
  balance   Decimal  @default(0) @db.Decimal(12, 2) // 用户余额（元）
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 与请求日志的一对多关系
  apiRequestLogs ApiRequestLog[] @relation("UserApiRequestLogs")
  // 与定价配置的多对多关系
  userPricings UserPricing[] @relation("UserUserPricings")

  @@map("users")
}

model ApiRequestLog {
  id             BigInt   @id @default(autoincrement())
  userClerkId    String   // 用户 Clerk ID
  user           User?    @relation("UserApiRequestLogs", fields: [userClerkId], references: [clerkId])
  serviceProvider String  // 服务商名称（记录时从 ApiPricing.name 复制，避免删除定价后无法显示）
  requestApi     String   // 请求接口（如方法+路径）
  requestBody    String   @db.Text // 请求参数
  responseBody   String   @db.Text // 返回参数/响应内容
  cost           Decimal  @db.Decimal(12, 4) // 请求费用
  createdAt      DateTime @default(now())    // 请求时间

  @@index([userClerkId, createdAt]) // 按用户和时间查询
  @@index([createdAt])              // 按时间范围查询
  @@index([cost])                   // 按费用区间/排序查询
  @@index([serviceProvider])        // 按服务商查询
  @@map("api_request_logs")
}

model UserPricing {
  id           BigInt     @id @default(autoincrement())
  userId       BigInt     // 用户 ID
  user         User       @relation("UserUserPricings", fields: [userId], references: [id])
  apiPricingId BigInt     // 定价配置 ID
  apiPricing   ApiPricing @relation("ApiPricingUserPricings", fields: [apiPricingId], references: [id])
  createdAt    DateTime   @default(now()) // 关联创建时间

  @@unique([userId, apiPricingId]) // 防止重复关联：同一用户不能重复关联同一服务商
  @@index([userId])                // 按用户查询
  @@index([apiPricingId])          // 按定价配置查询
  @@map("user_pricings")
}


